name: Build Desktop Releases

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  desktop:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      CARGO_TERM_COLOR: always

    steps:
      # 拉取代码
      - name: Checkout
        uses: actions/checkout@v4

      # 安装稳定版 Rust 工具链（用于核心逻辑）
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      # 安装稳定版 Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # Linux 桌面构建依赖
      - name: Install Linux desktop dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev

      # macOS 桌面构建依赖
      - name: Install macOS desktop dependencies
        if: matrix.os == 'macos-latest'
        run: |
          brew install cmake ninja pkg-config

      # Windows 桌面构建依赖
      - name: Install Windows desktop dependencies
        if: matrix.os == 'windows-latest'
        shell: bash
        run: |
          choco install -y ninja

      # 启用目标平台的桌面支持
      - name: Enable desktop targets
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            ubuntu-latest) flutter config --enable-linux-desktop ;;
            macos-latest) flutter config --enable-macos-desktop ;;
            windows-latest) flutter config --enable-windows-desktop ;;
          esac

      # 拉取 Dart/Flutter 依赖
      - name: Fetch Flutter packages
        run: flutter pub get

      # 安装 cargo-expand，避免 FRB 生成时自动安装带来的重试
      - name: Install cargo-expand
        run: cargo install cargo-expand --locked

      # 安装 FRB 代码生成工具（与仓库当前版本保持一致）
      - name: Install flutter_rust_bridge_codegen
        run: cargo install flutter_rust_bridge_codegen --locked --version 2.11.1

      # 根据最新 Rust 代码重新生成 FRB 绑定
      - name: Regenerate FRB bindings
        run: flutter_rust_bridge_codegen generate

      # 编译 Rust 库（release）
      - name: Build Rust crate (release)
        run: cargo build --manifest-path rust/Cargo.toml --release

      # 构建 Flutter 桌面可执行（release）
      - name: Build Flutter desktop app (release)
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            ubuntu-latest) flutter build linux --release ;;
            macos-latest) flutter build macos --release ;;
            windows-latest) flutter build windows --release ;;
          esac

      # 上传 Linux 构建工件
      - name: Upload artifact
        if: matrix.os == 'ubuntu-latest'
        uses: actions/upload-artifact@v4
        with:
          name: skydrivex-linux
          path: build/linux/x64/release/bundle/

      # 上传 Windows 构建工件
      - name: Upload artifact
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: skydrivex-windows
          path: build/windows/runner/Release/**/*

      # 上传 macOS 构建工件
      - name: Upload artifact
        if: matrix.os == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: skydrivex-macos
          path: build/macos/Build/Products/Release/*.app
